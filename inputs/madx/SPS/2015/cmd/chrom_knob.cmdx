!---|----1----|----2----|----3----|----4----|----5----|----6----|----7----|----8
!--------------------------------------------------------------------------
! Chromaticity knob calculation
! 
! G. Arduini - 03/05/2004
!--------------------------------------------------------------------------

QH:=table(summ,q1);
QV:=table(summ,q2);


select, flag=twiss, clear;
select, flag=twiss, range=#E,column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;
TWISS, DELTAP=0.0;
write, table=twiss, file=twiss.prt;

value, QH, QV;


/******************************************************
 * MATCH0:   DQ1=-33.6 & DQ2=0.0*QV
 ******************************************************/
match, sequence=SPS;

VARY, name=KSDA, step=0.0001;
VARY, name=KSDB, step=0.0001;
VARY, name=KSFA, step=0.0001;
VARY, name=KSFB, step=0.0001;

Global, sequence=SPS, DQ1=-33.6;
Global, sequence=SPS, DQ2=0.0*QV;
Global, sequence=SPS, Q1=QH;
Global, sequence=SPS, Q2=QV;

!Global, sequence=SPS, DDQ1=0.0;
!Global, sequence=SPS, DDQ2=0.0;

Lmdif, calls=500, tolerance=1e-6;
Endmatch;

value, KSDA, KSDB, KSFA, KSFB, KSFC;

select, flag=twiss, range=#E,column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;
TWISS, DELTAP=0.0;
write, table=twiss, file=twiss0.prt;



/******************************************************
 * MATCH1:   DQ1=0.1*QH & DQ2=0.0*QV
 ******************************************************/
match, sequence=SPS;

VARY, name=KSDA, step=0.0001;
VARY, name=KSDB, step=0.0001;
VARY, name=KSFA, step=0.0001;
VARY, name=KSFB, step=0.0001;

Global, sequence=SPS, DQ1=0.1*QH;
Global, sequence=SPS, DQ2=0.0*QV;
Global, sequence=SPS, Q1=QH;
Global, sequence=SPS, Q2=QV;

!Global, sequence=SPS, DDQ1=0.0;
!Global, sequence=SPS, DDQ2=0.0;

Lmdif, calls=500, tolerance=1e-6;
Endmatch;

value, KSDA,KSDB,KSFA,KSFB;
select, flag=twiss, range=#E,column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;
TWISS, DELTAP=0.0;
write, table=twiss, file=twiss1.prt;





/******************************************************
 * MATCH2:   DQ1=0.0*QH & DQ2=0.1*QV
 ******************************************************/
match, sequence=SPS;

VARY, name=KSDA, step=0.0001;
VARY, name=KSDB, step=0.0001;
VARY, name=KSFA, step=0.0001;
VARY, name=KSFB, step=0.0001;

Global, sequence=SPS, DQ1=0.0*QH;
Global, sequence=SPS, DQ2=0.1*QV;
Global, sequence=SPS, Q1=QH;
Global, sequence=SPS, Q2=QV;

!Global, sequence=SPS, DDQ1=0.0;
!Global, sequence=SPS, DDQ2=0.0;

Lmdif, calls=500, tolerance=1e-6;
Endmatch;

value, KSDA,KSDB,KSFA,KSFB;
select, flag=twiss, range=#E,column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;
TWISS, DELTAP=0.0;
write, table=twiss, file=twiss2.prt;

return;
