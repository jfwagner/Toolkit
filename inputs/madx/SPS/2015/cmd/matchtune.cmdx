!---|----1----|----2----|----3----|----4----|----5----|----6----|----7----|----8
!--------------------------------------------------------------------------
! Tune matching
!--------------------------------------------------------------------------



!--------------------------------------------------------------------------
! Before match
!--------------------------------------------------------------------------
select, flag=twiss, clear;
select, flag=twiss, range=#S/#E,
        column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;

TWISS, DELTAP=0.0;
write, table=twiss, file=twiss.prt;



!--------------------------------------------------------------------------
! match
!--------------------------------------------------------------------------
match, sequence=SPS;
Global, Q1=26.13, Q2=26.18;
VARY, name=KQD, step=0.0001;
VARY, name=KQF1, step=0.0001;
Lmdif,calls=10,tolerance=1.0e-21;
Endmatch;

value, KQD, KQF1, KQF2;



!--------------------------------------------------------------------------
! After match
!--------------------------------------------------------------------------
select, flag=twiss, clear;
select, flag=twiss, range=#S/#E
      , column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;

/**********************************************
select, flag=twiss, pattern="^BP.*"
      , column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;
select, flag=twiss, class=QM
      , column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;
select, flag=twiss, class=QMA
      , column=name,s,betx,alfx,mux,x,px,dx,dpx,bety,alfy,muy,y,py,dy,dpy;
 **********************************************/

TWISS, DELTAP=0.0;
write, table=twiss, file=twiss_after.prt;



!--------------------------------------------------------------------------
! Plot
! > gv madx01.eps
!--------------------------------------------------------------------------
resplot;
setplot, post=2;

plot, title='Twiss', table=twiss, style:=100, symbol:=4, haxis=s, vaxis1=dx;


return;
