option, warn,info;
system,"ln -fns /afs/cern.ch/eng/lhc/optics/HLLHCV1.0 slhc";
system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.503 db5";
system, "ln -fns /afs/cern.ch/user/a/ansantam/public/MADX/collimation coll"; // Collimation
option,-echo,-info,-warn;

call,file="slhc/toolkit/macro.madx";

on_disp=1;

mylhcbeam=1;

Option, -echo,-warn,-info;
REAL CONST l.TAN   = 3.7  ;REAL CONST l.TANAL = l.TAN;
REAL CONST l.TANAR = l.TAN;REAL CONST l.TANC  = l.TAN;
REAL CONST l.TCT   = 1.0;REAL CONST l.TCTH  = l.TCT;REAL CONST l.TCTVA = l.TCT;


if (mylhcbeam>2){
  call,file="slhc/hllhc_thinb4.seq";
} else {
  call,file="slhc/hllhc_thin.seq";
};


call, file = "ds_coll_IR7.madx";


call,file="slhc/opt_round_thin.madx";  ! beta*=15 cm, round optics


 call, file = "tcdq_ir6_2012.thin.madx";   	! longer TCDQ in IR6
 call, file = "tcl.ats.madx";  			! TCL4 and TCL6 in IR1/5
 call, file = "tctv.madx";			! TCTVA in IR2/8
 call, file = "tct_cell_5.madx";		! TCTs in front of Q5 in IR1/5


exec,mk_beam(7000);
!if (mylhcbeam<=2){
!  exec,check_ip(b1); survey,file="survey_lhcb1.tfs";
!  exec,check_ip(b2); survey,file="survey_lhcb2.tfs";
!} else {
!  exec,check_ip(b2); survey,file="survey_lhcb4.tfs";
!};

on_x1:=1.; on_sep1:=0;
on_x2:=1; on_sep2:=0; on_alice:=1;
on_x5:=1.; on_sep5:=0;
on_x8:=1; on_sep8:=0; on_lhcb:=1;


set,format="12.6f"; 
use,period=lhcb1;
select, flag=twiss, clear;
select, flag=twiss, 
column = name, s, l, x, y, aper_1, aper_2, aper_3, aper_4, alfx, alfy, px, py, sigxd, sigyd, betx, bety, sigx, ex, sigy, ey, dx, dpx, dy, dpy, wx, wy, T, PT, DELTAP, beta;
twiss, table = twiss, file = "twiss_ip1_b1.tfs";

sixtrack, radius=17E-03;


set,format="12.6f"; 
use,period=lhcb2;
select, flag=twiss, clear;
select, flag=twiss, 
column = name, s, l, x, y, aper_1, aper_2, aper_3, aper_4, alfx, alfy, px, py, sigxd, sigyd, betx, bety, sigx, ex, sigy, ey, dx, dpx, dy, dpy, wx, wy, T, PT, DELTAP, beta;
twiss, table = twiss, file = "twiss_ip1_b2.tfs";


//--------------
// Survey file
//--------------
if (mylhcbeam<=2){
  exec,check_ip(b1); survey,file="survey_ip1_b1.tfs";
  exec,check_ip(b2); survey,file="survey_ip1_b2.tfs";
} else {
  exec,check_ip(b2); survey,file="survey_ip1_b4.tfs";
};


seqedit, sequence = lhcb1; flatten; cycle, start = IP5; endedit;

set,format="12.6f"; 
use,period=lhcb1;
select, flag=twiss, clear;
select, flag=twiss, 
column = name, s, l, x, y, aper_1, aper_2, aper_3, aper_4, alfx, alfy, px, py, sigxd, sigyd, betx, bety, sigx, ex, sigy, ey, dx, dpx, dy, dpy, wx, wy, T, PT, DELTAP, beta;
twiss, table = twiss, file = "twiss_ip5_b1.tfs";

sixtrack, radius=17E-03;


set,format="12.6f"; 
use,period=lhcb2;
select, flag=twiss, clear;
select, flag=twiss, 
column = name, s, l, x, y, aper_1, aper_2, aper_3, aper_4, alfx, alfy, px, py, sigxd, sigyd, betx, bety, sigx, ex, sigy, ey, dx, dpx, dy, dpy, wx, wy, T, PT, DELTAP, beta;
twiss, table = twiss, file = "twiss_ip5_b2.tfs";

//--------------
// Survey file
//--------------
if (mylhcbeam<=2){
  exec,check_ip(b1); survey,file="survey_ip5_b1.tfs";
  exec,check_ip(b2); survey,file="survey_ip5_b2.tfs";
} else {
  exec,check_ip(b2); survey,file="survey_ip5_b4.tfs";
};


system, "rm db5 slhc";

return;
